# Participant Authentication with Invite Tokens

## Overview

All ASK participants must be linked to a user profile (`user_id` NOT NULL) to enable authentication via invite tokens. This ensures secure access to ASK sessions using personalized magic links.

## Why user_id is Required

Invite tokens are generated automatically for each participant and used to create personalized magic links. When a participant accesses an ASK via their invite link:

1. The API validates the `invite_token` in the URL
2. The API retrieves the associated `ask_participant` record
3. The API extracts the `user_id` to identify the authenticated user
4. The participant can then post messages linked to their profile

**Without a `user_id`, the authentication fails with a 403 Forbidden error.**

## How Participants are Created

### Via Admin Dashboard

When creating or editing an ASK session in the admin dashboard, participants can be added in two ways:

1. **By User ID** (from existing users dropdown)
   - User is already in the system with a profile
   - `user_id` is set directly
   - ✅ Guaranteed to work with invite tokens

2. **By Email Address**
   - System checks if a profile exists for this email
   - If not, creates a new auth user and profile via `ensureProfileExists()`
   - Links the participant to the new profile
   - ✅ Guaranteed to work with invite tokens

### Error Handling

If profile creation fails for an email (network error, invalid email, etc.):
- The participant is **NOT created** (as of migration 044)
- An error is logged in the console
- The admin receives feedback about failed emails
- This prevents orphan participants without authentication

## Database Schema

```sql
CREATE TABLE ask_participants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  ask_session_id UUID NOT NULL REFERENCES ask_sessions(id),
  user_id UUID NOT NULL REFERENCES profiles(id), -- ⚠️ REQUIRED (as of migration 044)
  participant_email VARCHAR(255),
  invite_token VARCHAR(255) UNIQUE, -- Auto-generated by trigger
  role VARCHAR(50),
  ...
);
```

### Constraints

- `user_id` is NOT NULL (enforced by migration 044)
- `invite_token` is auto-generated by the `generate_invite_token()` trigger
- `invite_token` is unique across all participants

## API Behavior

### Creating Participants (POST /api/admin/asks)

```typescript
// ✅ CORRECT: Participant with user_id
{
  ask_session_id: "uuid",
  user_id: "uuid", // REQUIRED
  participant_email: "user@example.com",
  role: "participant"
}

// ❌ INCORRECT: No longer allowed (will fail at DB level)
{
  ask_session_id: "uuid",
  participant_email: "user@example.com", // No user_id
  role: "participant"
}
```

### Authenticating with Invite Token (POST /api/ask/[key])

The API supports two authentication methods:

1. **Regular Auth** (logged-in user)
   - User has active session
   - `profileId` extracted from session

2. **Invite Token Auth** (passwordless user with magic link)
   - `X-Invite-Token` header present
   - `participantId` and `profileId` extracted from token
   - **`profileId` is REQUIRED** - the API will reject tokens without a linked user profile
   - Messages are always linked to a user profile (no anonymous participants)

## Migration 045

The migration `045_require_user_id_for_participants.sql` enforces this requirement:

1. Deletes orphan participants without `user_id`
2. Makes `user_id` NOT NULL
3. Updates the trigger to verify `user_id` exists
4. Adds a check constraint for clarity

## Testing

To verify this works:

1. Create an ASK session via admin dashboard
2. Add participants by email
3. Check that all participants have a `user_id` in the database
4. Send invite emails
5. Access ASK via invite link
6. Verify authentication succeeds (no 403 error)
7. Post a message in voice mode
8. Verify message is persisted with correct `user_id`

## Troubleshooting

### 403 Forbidden: "Ce lien d'invitation n'est pas correctement configuré"

**Cause**: Participant has no `user_id` (orphan participant from before migration 045)

**Solution**:
1. Run migration 045 to clean up orphan participants:
   ```bash
   npm run migrate
   ```
2. Re-create the participant via admin dashboard
3. Send a new invite email with the regenerated token
4. Verify the participant has a `user_id` in the database:
   ```sql
   SELECT id, user_id, participant_email, invite_token
   FROM ask_participants
   WHERE id = '<participant-id>';
   ```

### Participant creation fails silently

**Cause**: `ensureProfileExists()` throws an error (e.g., invalid email, network issue, Supabase auth error)

**Solution**:
1. Check server logs for error details:
   ```
   ❌ Failed to create profile for <email>: <error>
   ```
2. Verify email format is valid
3. Verify Supabase auth service is accessible
4. Check if the email already exists in `auth.users` but not linked to a profile
5. Retry participant creation from admin dashboard

### No anonymous participants allowed

**By Design**: All participants must have a `user_id` linked to a user profile.

This ensures:
- Proper authentication via invite tokens
- Messages are always attributed to a real user
- Security and accountability for all actions
- No orphan data in the database

## Code References

- Participant creation: [/api/admin/asks/route.ts:193-234](../src/app/api/admin/asks/route.ts#L193-L234)
- Invite token validation: [/api/ask/[key]/route.ts:650-673](../src/app/api/ask/[key]/route.ts#L650-L673)
- Profile creation: [profiles.ts:14-148](../src/lib/profiles.ts#L14-L148)
- Database trigger: [migrations/032_add_invite_tokens.sql](../migrations/032_add_invite_tokens.sql)
- Enforcement migration: [migrations/045_require_user_id_for_participants.sql](../migrations/045_require_user_id_for_participants.sql)
